<html>
    <head>
        <title>Block Blog</title>
        <style>
            html {
                background: #222;
                color: white;
            }
            input, textarea, button {
                background: #555;
                color: white;
            }
            .title {
                font-size: 22px;
                line-height: 0px;
            }
            .author, .date {
                font-size: 20px;
            }
            #title, #body {
                width: 400px;
            }
            #author {
                width: 340px;
            }
            #secret {
                width: 60px;
            }
            #body {
                height: 200px;
                font-family: sans-serif;
            }
            #posts {
                border: 2px solid white;
                padding: 10px;
            }
            #poster {
                padding: 10px;
                font-size: 18px;
            }
        </style>
    </head>
    <body>
        <h2>Block Blog</h2>
        <input id="title" placeholder="Title"><br/>
        <input id="author" placeholder="Author"><input id="secret" placeholder="Secret"><br/>
        <textarea id="body" placeholder="Body"></textarea><br/>
        <button id="poster" onclick="publishPost()">Post!</button><br/><br/>
        <div id="posts">fetching posts</div>
        <script>
            let noHacks = (text) => text.replaceAll("&", "&amp;").replaceAll("<", "&lt;").replaceAll(">", "&gt;");
            let theToken = "UuDYJ2vUqS4YfPJmT5wIGvnkpgSYXf4W9piG_phg reraeB".split("").reverse().join("");
            
            async function getPosts() {
                let fetching_response = await fetch(
                    "https://api.github.com/gists/8de4923bdd0d849f271bd4f9cfb2f8c1", {
                        method: "GET",
                        headers: {
                            "Accept": "application/vnd.github+json",
                            "Authorization": theToken
                        }
                    }
                );
                return fetching_response.json();
            }
            
            function baseFortySix(str, f) {
                let _46_ = "";
                for(let i of str) {
                    _46_ += i;
                    for(let j=0; j<f; j++) {
                        _46_ += "qwerasdfzxcvbnmghjkltyuiopQAZXCDEWSRFVBNHGTYUIOPJKLM1234567890_+"[Math.floor(Math.random()*64)];
                    }
                }
                return _46_;
            }
            
            async function publishPost() {
                let t = document.getElementById("title").value;
                let a = document.getElementById("author").value;
                let s = document.getElementById("secret").value;
                let b = document.getElementById("body").value;
                if(!t || !a || !b) {let answer = confirm("You've left some fields blank. Post anyway?"); if(!answer) {return;}}
                let pre_posting_response = getPosts().then(async function(data) {
                    let prevPosts = data.files["torinsgist.txt"].content.slice(1, -1).replaceAll('\\"', '"');
                    let JSONified = JSON.parse(prevPosts);
                    JSONified.posts.push({"title": t, "author": a, "secret": baseFortySix(s,t.length), "body": b, "date": Date.now()});
                    let body = '"' + JSON.stringify(JSONified).replaceAll('"', '\\"') + '"';
                    let posting_response = await fetch(
                        "https://api.github.com/gists/8de4923bdd0d849f271bd4f9cfb2f8c1", {
                            method: "PATCH",
                            headers: {
                                "Accept": "application/vnd.github+json",
                                "Authorization": theToken
                            },
                            body: JSON.stringify({
                                gist_id: "e38c31fbf1881a826f776cdb7393b793",
                                files: {
                                    "torinsgist.txt": {
                                        content: body
                                    }
                                }
                            })
                        }
                    );
                    posting_response.json().then(function(data) {}).catch((err) => alert("Posting error: "+err)); 
                    updateThePosts(); // so you can see your own post
                }).catch((err) => alert("Pre-posting error: "+err));
                document.getElementById("title").value = "";
                document.getElementById("body").value = "";
            }
            
            let thePosts = getPosts();
            function updateThePosts() {thePosts = getPosts();}
            function displayPosts() {
                let _=($,__)=>__.split("").filter((e,i)=>i%($+1)==0).join("");thePosts.then(function(data) {
                    let postList = JSON.parse(data.files["torinsgist.txt"].content.slice(1, -1).replaceAll('\\"', '"')).posts;
                    document.getElementById("posts").innerHTML = postList.reverse().map(
                        (p) => `
<b class="title">${noHacks((p.title ? p.title : "Untitled"))}</b>
posted by <span class="author">${noHacks(p.author ? p.author : "anonymous")}</span>${p.secret ? (p.author == "Torin" &&
    _(p.title.length, p.secret) == "own3r" ? " ‚≠ê <i style='color:darkorange'>Owner</i>" : (
    p.secret == "imahacker" ? " üíª <i style='color:cyan'>Hacker</i>" : ""
)) : ""}<span class="date">
${((Date.now()-p.date) > 864e5 ? " "+Math.floor((Date.now()-p.date)/864e5)+"d" : "")}
${((Date.now()-p.date) > 36e5 ? " "+Math.floor(((Date.now()-p.date) % 864e5)/36e5)+"h" : "")}
${((Date.now()-p.date) > 6e4 ? " "+Math.floor(((Date.now()-p.date) % 36e5)/6e4)+"m" : "")}
${((Date.now()-p.date) > 1e3 ? " "+Math.floor(((Date.now()-p.date) % 6e4)/1e3)+"s" : " now")}
</span> ago
<p class="body">${noHacks(p.body)}</p>`
                    ).join("-".repeat(50) + "<br/>")
                });
            }
            updateThePosts();
            setInterval(updateThePosts, 12e4); // update the posts every couple minutes
            displayPosts();
            setInterval(displayPosts, 1000);
        </script>
    </body>
</html>
